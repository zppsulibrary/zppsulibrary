<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <title>Admin Dashboard</title>
    <!-- SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SheetJS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>

    <div class="sidebar">
        <div class="logo">
            <img src="../img/zppuslibrarylogo.png" alt="Logo">
        </div>        
        <h2>Admin Dashboard</h2>
        <ul>
            <li><a href="index.html" id="dashboard-link" class="active"><i class="bi bi-speedometer2"></i>Dashboard</a></li>
            <li id="history-link-container">
                <a href="#" id="history-link"><i class="bi bi-clock-history"></i>History</a>
                <ul id="history-dropdown" class="dropdown">
                    <li><a href="studentreg.html">Student Registrations</a></li>
                    <li><a href="facultyreg.html">Faculty Registrations</a></li>
                    <li><a href="admin_registrations.html">Admin Registrations</a></li>
                    <li><a href="visitor_registrations.html">Visitor Registrations</a></li>
                </ul>
            </li>
            <li><a href="#" id="logout"><i class="bi bi-box-arrow-right"></i>Logout</a></li>
        </ul>
        
    </div>

    <div class="main-content">
        <div class="header">
            <h1>Welcome, Admin</h1>
        </div>
        <div class="card">
            <h3>Student Registration Details</h3>
            <input type="text" id="search-student-bar" placeholder="Search by name..." />
            <button class="toggle-btn" onclick="toggleCard('student-card')">üëÅÔ∏è</button>
            <div id="student-card">
                <table id="student-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Last Name</th>
                            <th>Given Name</th>
                            <th>MI</th>
                            <th>Program</th>
                            <th>Course</th>
                            <th>Major</th>
                            <th>School Year</th>
                            <th>Semester</th>
                            <th>Type of Patron</th>
                        </tr>
                    </thead>
                    <tbody id="student-table-body">
                        <tr>
                            <td colspan="10">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="card">
            <h3>Faculty Registration Details</h3>
            <input type="text" id="search-faculty-bar" placeholder="Search by name..." />
            <button class="toggle-btn" onclick="toggleCard('faculty-card')">üëÅÔ∏è</button>
            <div id="faculty-card">
                <table id="faculty-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Last Name</th>
                            <th>Given Name</th>
                            <th>MI</th>
                            <th>Program</th>
                        </tr>
                    </thead>
                    <tbody id="faculty-table-body">
                        <tr>
                            <td colspan="5">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="card">
            <h3>Admin Registration Details</h3>
            <input type="text" id="search-admin-bar" placeholder="Search by name..." />
            <button class="toggle-btn" onclick="toggleCard('admin-card')">üëÅÔ∏è</button>
            <div id="admin-card">
                <table id="admin-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Last Name</th>
                            <th>Given Name</th>
                            <th>MI</th>
                            <th>Department</th>
                        </tr>
                    </thead>
                    <tbody id="admin-table-body">
                        <tr>
                            <td colspan="5">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="card">
            <h3>Visitor Registration Details</h3>
            <input type="text" id="search-visitor-bar" placeholder="Search by name..." />
            <button class="toggle-btn" onclick="toggleCard('visitor-card')">üëÅÔ∏è</button>
            <div id="visitor-card">
                <table id="visitor-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Last Name</th>
                            <th>Given Name</th>
                            <th>MI</th>
                            <th>School Field</th>
                        </tr>
                    </thead>
                    <tbody id="visitor-table-body">
                        <tr>
                            <td colspan="5">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <script>
            function toggleCard(cardId) {
                const card = document.getElementById(cardId);
                const toggleButton = event.target;
        
                // Toggle visibility of the whole card
                if (card.style.display === "none") {
                    card.style.display = "block";
                    toggleButton.textContent = "üëÅÔ∏è";  // Show eye icon when card is visible
                } else {
                    card.style.display = "none";
                    toggleButton.textContent = "üëÅÔ∏è‚Äçüó®Ô∏è";  // Show eye with a slash when card is hidden
                }
            }

            document.getElementById("history-link").addEventListener("click", function(event) {
    event.preventDefault();  // Prevents the default action of the link
    const dropdown = document.getElementById("history-dropdown");
    // Toggle the display style between "block" (visible) and "none" (hidden)
    if (dropdown.style.display === "none" || dropdown.style.display === "") {
        dropdown.style.display = "block";
    } else {
        dropdown.style.display = "none";
    }
});

        </script>
        
        <style>
            .toggle-btn {
                background: none;
                border: none;
                font-size: 20px;
                cursor: pointer;
                position: absolute;
                right: 10px;
            }
        
            .card {
                position: relative;
                padding-right: 40px;
            }
        
            .card div {
                display: block;  /* Show content by default */
            }
            /* Style for the search bar */
input[type="text"] {
    width: 90vh;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 16px;
    box-sizing: border-box; /* Ensure padding doesn't affect the width */
    transition: border-color 0.3s ease;
}

/* Add focus effect */
input[type="text"]:focus {
    border-color: #007bff; /* Change border color on focus */
    outline: none; /* Remove default focus outline */
}

/* Style for the placeholder text */
input[type="text"]::placeholder {
    color: #888;
    font-style: italic;
}
        </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAATH_41xPWHK7FWORsbKvFZNjgN0nwzS8",
            authDomain: "zppsulibrary-3f15b.firebaseapp.com",
            projectId: "zppsulibrary-3f15b",
            storageBucket: "zppsulibrary-3f15b.appspot.com",
            messagingSenderId: "693170608073",
            appId: "1:693170608073:web:09d728cfb6489d7675fa18"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let registrations = []; // Global variable to store fetched data
        
        // Check if user is logged in
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "login.html";
            }
        });
        
        // Logout function
        function logout() {
            Swal.fire({
                title: 'Are you sure?',
                text: 'You are about to log out from the dashboard!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, log me out!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    signOut(auth)
                        .then(() => {
                            window.location.href = "login.html";
                        })
                        .catch((error) => {
                            console.error("Error logging out:", error.message);
                        });
                }
            });
        }
        
        document.getElementById("logout").addEventListener("click", logout);
        
       // Fetch and listen for real-time updates from Firestore
function fetchRegistrations() {
    const registrationsCollection = collection(db, "registrations");

    // Listen for changes in the 'registrations' collection in real-time
    onSnapshot(registrationsCollection, (snapshot) => {
        registrations = [];
        const studentTableBody = document.getElementById("student-table-body");
        const facultyTableBody = document.getElementById("faculty-table-body");
        const adminTableBody = document.getElementById("admin-table-body");
        const visitorTableBody = document.getElementById("visitor-table-body");

        // Clear existing table rows
        studentTableBody.innerHTML = "<tr><td colspan='10'>Loading...</td></tr>";
        facultyTableBody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
        adminTableBody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
        visitorTableBody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";

        snapshot.forEach((doc) => {
            const data = doc.data();
            registrations.push(data);
        });

        let studentData = registrations.filter(reg => reg["patron-type"] === "Student");
        let facultyData = registrations.filter(reg => reg["patron-type"] === "Faculty");
        let adminData = registrations.filter(reg => reg["patron-type"] === "Admin");
        let visitorData = registrations.filter(reg => reg["patron-type"] === "Visitor");

        // Render each table
        renderTable("student", studentData);
        renderTable("faculty", facultyData);
        renderTable("admin", adminData);
        renderTable("visitor", visitorData);
    });
}

// Render the tables based on patron type
function renderTable(type, data) {
    const tableBody = document.getElementById(`${type}-table-body`);
    tableBody.innerHTML = "";

    // Reverse the data so the newest entries come first
    const reversedData = data.reverse();

    reversedData.forEach((item, index) => {
        let row;
        if (type === "student") {
            row = `
                <td>${index + 1}</td>
                <td>${item.lastname || "N/A"}</td>
                <td>${item.givenname || "N/A"}</td>
                <td>${item.mi || "N/A"}</td>
                <td>${item.program || "N/A"}</td>
                <td>${item.course || "N/A"}</td>
                <td>${item.major || "N/A"}</td>
                <td>${item.school_year || "N/A"}</td>
                <td>${item.semester || "N/A"}</td>
                <td>${item["patron-type"] || "N/A"}</td>
            `;
        } else if (type === "faculty") {
            row = `
                <td>${index + 1}</td>
                <td>${item.lastname || "N/A"}</td>
                <td>${item.givenname || "N/A"}</td>
                <td>${item.mi || "N/A"}</td>
                <td>${item.program || "N/A"}</td>
            `;
        } else if (type === "admin") {
            row = `
                <td>${index + 1}</td>
                <td>${item.lastname || "N/A"}</td>
                <td>${item.givenname || "N/A"}</td>
                <td>${item.mi || "N/A"}</td>
                <td>${item.department || "N/A"}</td>
            `;
        } else if (type === "visitor") {
            row = `
                <td>${index + 1}</td>
                <td>${item.lastname || "N/A"}</td>
                <td>${item.givenname || "N/A"}</td>
                <td>${item.mi || "N/A"}</td>
                <td>${item.school || "N/A"}</td>
            `;
        }

        const newRow = document.createElement("tr");
        newRow.innerHTML = row;
        tableBody.appendChild(newRow);
    });
}


// Search functionality for each table
document.getElementById("search-student-bar").addEventListener("input", (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const filteredData = registrations.filter((reg) =>
        reg["patron-type"] === "Student" &&
        (reg.givenname?.toLowerCase().includes(searchTerm) ||
         reg.lastname?.toLowerCase().includes(searchTerm))
    );
    renderTable("student", filteredData);
});

document.getElementById("search-faculty-bar").addEventListener("input", (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const filteredData = registrations.filter((reg) =>
        reg["patron-type"] === "Faculty" &&
        (reg.givenname?.toLowerCase().includes(searchTerm) ||
         reg.lastname?.toLowerCase().includes(searchTerm))
    );
    renderTable("faculty", filteredData);
});

document.getElementById("search-admin-bar").addEventListener("input", (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const filteredData = registrations.filter((reg) =>
        reg["patron-type"] === "Admin" &&
        (reg.givenname?.toLowerCase().includes(searchTerm) ||
         reg.lastname?.toLowerCase().includes(searchTerm))
    );
    renderTable("admin", filteredData);
});

document.getElementById("search-visitor-bar").addEventListener("input", (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const filteredData = registrations.filter((reg) =>
        reg["patron-type"] === "Visitor" &&
        (reg.givenname?.toLowerCase().includes(searchTerm) ||
         reg.lastname?.toLowerCase().includes(searchTerm))
    );
    renderTable("visitor", filteredData);
});

fetchRegistrations();

    </script>


</body>
</html>
