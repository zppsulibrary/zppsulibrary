<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css">
    <script src="script.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js"></script>
    <title>ZPPSU LIBRARY Registration Form</title>
</head>
<body>
    <div class="container">
        <div class="title">ZPPSU LIBRARY Registration Form</div>
        <form action="#" method="post">
            <label for="lastname">Name:</label>
            <div class="name-group">
                <input type="text" id="lastname" name="lastname" placeholder="Lastname" required>
                <input type="text" id="givenname" name="givenname" placeholder="Givenname" required>
                <input type="text" id="mi" name="mi" placeholder="MI" maxlength="1" required>
            </div>
            <label for="program">Program:</label>
            <select id="program" name="program" onchange="updateCourses()" required>
                <option value="">-- Select Program --</option>
                <option value="CAT">CAT</option>
                <option value="CTE">CTE</option>
                <option value="CICS">CICS</option>
            </select>
            
            <select id="course" name="course" required>
                <option value="">-- Select Course --</option>
            </select>
            
            <select id="major" name="major">
                <option value="">-- Select Major --</option>
            </select>            
            <label for="patron-type">Type of Patrons:</label>
            <select id="patron-type" name="patron-type" required>
                <option value="">-- Select Patrons --</option>
                <option value="student">Student</option>
                <option value="faculty">Faculty</option>
                <option value="adviser">Adviser</option>
                <option value="visitor">Visitor</option>
            </select>
            <label for="school-year">School Year:</label>
            <select id="school-year" name="school-year" required>
                <option value="">-- Select School Year --</option>
                <option value="2024-2025">2024-2025</option>
                <option value="2026-2027">2026-2027</option>
            </select>
            <label for="semester">Semester:</label>
            <select id="semester" name="semester" required>
                <option value="">-- Select Semester --</option>
                <option value="1st">1st</option>
                <option value="2nd">2nd</option>
            </select>
            <button type="submit" class="submit-button">Submit</button>
        </form>
        
    </div>
</body>
<script>
    // Firebase configuration
    const firebaseConfig = {
  apiKey: "AIzaSyAATH_41xPWHK7FWORsbKvFZNjgN0nwzS8",
  authDomain: "zppsulibrary-3f15b.firebaseapp.com",
  projectId: "zppsulibrary-3f15b",
  storageBucket: "zppsulibrary-3f15b.firebasestorage.app",
  messagingSenderId: "693170608073",
  appId: "1:693170608073:web:5a92d9c695a10bc975fa18"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
console.log("Firebase initialized");

// Get Firestore instance
const db = firebase.firestore();

// Anonymous authentication setup
async function signInAnonymously() {
    try {
        const userCredential = await firebase.auth().signInAnonymously();
        console.log("User signed in anonymously", userCredential);
        return userCredential.user;
    } catch (error) {
        console.error("Error signing in anonymously: ", error);
        alert("Error signing in. Please try again.");
        return null;
    }
}

// Form submission handler
document.querySelector('form').addEventListener('submit', async (event) => {
    event.preventDefault(); // Prevent form from refreshing the page
    console.log("Form submission triggered");

    // Get form data
    const lastname = document.getElementById('lastname').value;
    const givenname = document.getElementById('givenname').value;
    const mi = document.getElementById('mi').value;
    const program = document.getElementById('program').value;
    const course = document.getElementById('course').value;
    const major = document.getElementById('major').value;
    const patronType = document.getElementById('patron-type').value;
    const schoolYear = document.getElementById('school-year').value;
    const semester = document.getElementById('semester').value;

    // Log form data for debugging
    console.log("Form Data:", {
        lastname,
        givenname,
        mi,
        program,
        course,
        major,
        patronType,
        schoolYear,
        semester
    });

    // Sign in the user anonymously
    const user = await signInAnonymously();
    if (!user) {
        return; // If no user, exit early
    }

    // Create a new document ID for this user (using the UID)
    const docId = user.uid;

    // Add data to Firestore
    try {
        console.log("Attempting to add data to Firestore with document ID:", docId);
        await db.collection('libraryRegistrations').doc(docId).set({
            lastname,
            givenname,
            mi,
            program,
            course,
            major,
            patronType,
            schoolYear,
            semester,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        console.log("Registration successful!");
        alert("Registration successful!");
    } catch (error) {
        console.error("Error adding document: ", error);
        alert("Error registering. Please try again.");
    }
});

</script>
</html>