<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/index.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="script.js" defer></script>
    <title>ZPPSU LIBRARY Registration Form</title>
</head>
<body>
    <div class="container">
        <div class="title">ZPPSU LIBRARY Registration Form</div>
        <form id="registrationForm" action="#" method="post">
            <label for="lastname">Name:</label>
            <div class="name-group">
                <input type="text" id="lastname" name="lastname" placeholder="Lastname" required>
                <input type="text" id="givenname" name="givenname" placeholder="Givenname" required>
                <input type="text" id="mi" name="mi" placeholder="MI" maxlength="1" required>
            </div>
            <label for="program">Program:</label>
            <select id="program" name="program" onchange="updateCourses()" required>
                <option value="">-- Select Program --</option>
                <option value="CTE">CTE</option>
                <option value="CICS">CICS</option>
                <option value="CET">CET</option>
            </select>
            <label for="course">Course:</label>
            <select id="course" name="course" required>
                <option value="">-- Select Course --</option>
            </select>
            <label for="major">Major:</label>
            <select id="major" name="major">
                <option value="">-- Select Major --</option>
            </select>
            <label for="patron-type">Type of Patrons:</label>
            <select id="patron-type" name="patron-type" required>
                <option value="">-- Select Patrons --</option>
                <option value="student">Student</option>
                <option value="faculty">Faculty</option>
                <option value="adviser">Adviser</option>
                <option value="visitor">Visitor</option>
            </select>
            <label for="school-year">School Year:</label>
            <select id="school-year" name="school-year" required>
                <option value="">-- Select School Year --</option>
                <option value="2024-2025">2024-2025</option>
                <option value="2026-2027">2026-2027</option>
            </select>
            <label for="semester">Semester:</label>
            <select id="semester" name="semester" required>
                <option value="">-- Select Semester --</option>
                <option value="1st">1st</option>
                <option value="2nd">2nd</option>
            </select>
            <button type="submit" class="submit-button">Submit</button>
        </form>
    </div>

    <!-- Firebase App and Firestore -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, addDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
    
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAATH_41xPWHK7FWORsbKvFZNjgN0nwzS8",
            authDomain: "zppsulibrary-3f15b.firebaseapp.com",
            projectId: "zppsulibrary-3f15b",
            storageBucket: "zppsulibrary-3f15b.firebasestorage.app",
            messagingSenderId: "693170608073",
            appId: "1:693170608073:web:09d728cfb6489d7675fa18"
        };
    
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
    
        // Function to format the date in DD/MM/YY 12-hour format with AM/PM
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = String(date.getFullYear()).slice(-2);
            
            let hours = date.getHours();
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
    
            // Convert to 12-hour format
            hours = hours % 12;
            hours = hours ? String(hours).padStart(2, '0') : '12';  // The hour '0' should be '12'
    
            return `${day}/${month}/${year} ${hours}:${minutes} ${ampm}`;
        }
    
        // Handle form submission
        document.querySelector("#registrationForm").addEventListener("submit", async (event) => {
            event.preventDefault();
    
            // Collect form data
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
    
            // Add the current date and time to the data in desired format
            const currentDate = new Date();
            data.submissionDate = formatDate(currentDate); // Store formatted date and time
    
            // Display confirmation dialog
            const result = await Swal.fire({
                title: "Submit Registration?",
                text: "Make sure all details are correct.",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "Submit",
                cancelButtonText: "Cancel"
            });
    
            if (result.isConfirmed) {
                try {
                    // Query Firestore to check if the user already exists
                    const registrationsRef = collection(db, "registrations");
                    const q = query(
                        registrationsRef,
                        where("lastname", "==", data.lastname),
                        where("givenname", "==", data.givenname),
                        where("mi", "==", data.mi)
                    );
                    const querySnapshot = await getDocs(q);
    
                    if (!querySnapshot.empty) {
                        // User already exists, increment scanCount
                        const existingDoc = querySnapshot.docs[0];
                        const existingData = existingDoc.data();
                        const updatedScanCount = (existingData.scanCount || 1) + 1;
    
                        // Update the document in Firestore
                        await updateDoc(doc(db, "registrations", existingDoc.id), {
                            scanCount: updatedScanCount,
                            submissionDate: formatDate(currentDate) // Update submission date
                        });
    
                        // Alert for updated registration
                        Swal.fire({
                            title: "Registration Updated",
                            text: "This registration already exists. The scan count has been updated.",
                            icon: "info",
                            timer: 3000,
                            showConfirmButton: false
                        });
                    } else {
                        // User does not exist, create a new document
                        data.scanCount = 1; // Initial scan count
                        await addDoc(registrationsRef, data);
    
                        Swal.fire({
                            title: "Success!",
                            text: "Your registration has been submitted.",
                            icon: "success",
                            timer: 3000,
                            showConfirmButton: false
                        });
                    }
    
                    // Reset the form and dropdowns
                    event.target.reset();
                    document.getElementById("course").innerHTML = "<option value=''>-- Select Course --</option>";
                    document.getElementById("major").innerHTML = "<option value=''>-- Select Major --</option>";
    
                } catch (error) {
                    Swal.fire({
                        title: "Error",
                        text: `Failed to submit registration: ${error.message}`,
                        icon: "error"
                    });
                }
            } else {
                Swal.fire({
                    title: "Cancelled",
                    text: "Your registration was not submitted.",
                    icon: "error"
                });
            }
        });
    </script>    
    
</body>
</html>
